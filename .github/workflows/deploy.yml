name: deploy website (S3-EC2)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
          
      - name: configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: upload src to S3
        run: | 
          aws s3 sync src/ s3://${{ secrets.S3_BUCKET }}/ --delete

      # EC2 preflight (check if EC2 secrets are available, skip otherwise)
      - name: EC2 preflight check
        id: preflight
        env:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
        run: |
          set -e
          missing=0
          for k in host username key; do
            v="$(printenv "$k" || true)"
            if [ -z "$v" ]; then
              echo "missing EC2 secret: $k"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "EC2 secrets not configured; skipping EC2 deploy."
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: deploy on EC2 (pull from S3, reload NGINX)
        if: steps.preflight.outputs.ready == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: | 
            set -e 
            sudo mkdir -p /var/www/animal_quiz
            sudo chown -R $USER:$USER /var/www/animal_quiz

            aws s3 sync s3://${{ secrets.S3_BUCKET }}/ /var/www/animal_quiz/ --delete 
            sudo systemctl reload nginx 
        
