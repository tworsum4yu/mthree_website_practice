name: deploy website (S3-EC2)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: pre-flight (Skip until Secrets exist)
        id: preflight
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: | 
          set -e
          S3_missing=0
          EC2_missing=0
          for k in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_REGION S3_BUCKET; do
            v="$(printenv "$k" || true)"
            if [ -z "$v" ]; then 
              echo "missing S3 secret: $k"
              S3_missing=1
            fi
          done

          for i in EC2_HOST EC2_USER EC2_SSH_KEY; do
            v="$(printenv "$i" || true)"
            if [ -z "$v" ]; then 
              echo "missing EC2 secret: $i"
              EC2_missing=1
            fi
          done

          if [ "$S3_missing" -eq 1 ]; then
            echo "S3_ready=false" >> "$GITHUB_OUTPUT"
            echo "Secret not configured, skipping deployment"
          else
            echo "S3_ready=true" >> "$GITHUB_OUTPUT"
          fi

          if [ "$EC2_missing" -eq 1 ]; then
            echo "EC2_ready=false" >> "$GITHUB_OUTPUT"
            echo "Secret not configured, skipping deployment"
          else
            echo "EC2_ready=true" >> "$GITHUB_OUTPUT"
          fi
          
      - name: configure AWS
        if: steps.preflight.outputs.S3_ready == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: upload src to S3
        if: steps.preflight.outputs.S3_ready == 'true'
        run: | 
          aws s3 sync src/ s3://${{ secrets.S3_BUCKET }}/site/ --delete

      - name: deploy on EC2 (Pull from S3. Reload NGINX)
        if: steps.preflight.outputs.EC2_ready == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: | 
            set -e 
            sudo mkdir -p /var/www/save_practice_site
            sudo chown -R $USER:$USER /var/www/save_practice_site

            aws s3 sync s3://${{ secrets.S3_BUCKET }}/site/ /var/www/save_practice_site --delete 
            sudo systemctl reload nginx 
        
